generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Avion {
  id                   Int       @id @default(autoincrement())
  marca                String
  modelo               String
  numeroSerie          String?
  matricula            String    @unique
  TSN                  Float?
  vencimientoMatricula DateTime?
  vencimientoSeguro    DateTime?

  certificadoMatriculaId Int?
  certificadoMatricula   Archivo? @relation("AvionCertificadoMatricula", fields: [certificadoMatriculaId], references: [id])

  archivado       Boolean            @default(false)
  propietarios    AvionPropietario[]
  avisos          Aviso[]            @relation("AvisosDelAvion")
  ComponenteAvion ComponenteAvion[]
  ordenesTrabajo  OrdenTrabajo[]
}

model ComponenteAvion {
  id          Int       @id @default(autoincrement())
  tipo        String
  marca       String?
  modelo      String?
  numeroSerie String?
  estado      Estado    @default(ACTIVO)
  TSN         Float?
  /// pasa automaticamenr=te a TSN cuando se edita ////
  TSO         Float?
  TBOFecha    DateTime?
  TBOHoras    Int?
  avionId     Int
  avion       Avion     @relation(fields: [avionId], references: [id])
}

model ComponenteExterno {
  id             Int            @id @default(autoincrement())
  tipo           String?
  marca          String
  modelo         String
  numeroSerie    String
  numeroParte    String?
  TSN            Float?
  TSO            Float?
  TBOFecha       DateTime?
  TBOHoras       Int?
  propietarioId  Int
  archivado      Boolean        @default(false)

  archivo8130Id  Int?
  archivo8130    Archivo?       @relation("ComponenteArchivo8130", fields: [archivo8130Id], references: [id])
  
  propietario    Propietario    @relation(fields: [propietarioId], references: [id])
  ordenesTrabajo OrdenTrabajo[]
}

model Propietario {
  id              Int                 @id @default(autoincrement())
  tipoPropietario TipoPropietario     @default(PERSONA)
  nombre          String?
  apellido        String?
  nombreEmpresa   String?
  rut             String?
  email           String?
  telefono        String?
  direccion       String?
  archivado       Boolean             @default(false)
  aviones         AvionPropietario[]
  componentes     ComponenteExterno[]
}

model AvionPropietario {
  id            Int         @id @default(autoincrement())
  avionId       Int
  propietarioId Int
  avion         Avion       @relation(fields: [avionId], references: [id])
  propietario   Propietario @relation(fields: [propietarioId], references: [id])
}

model Empleado {
  id                  Int                 @id @default(autoincrement())
  nombre              String
  apellido            String
  email               String?
  telefono            String
  esCertificador      Boolean             @default(false)
  esTecnico           Boolean             @default(false)
  direccion           String?
  tipoLicencia        TipoLicencia[]
  numeroLicencia      String?
  vencimientoLicencia DateTime?
  fechaAlta           DateTime?
  carneSaludId        Int?
  horasTrabajadas     Float               @default(0)
  archivado           Boolean             @default(false)
  carneSalud          Archivo?            @relation("EmpleadoCarneSalud", fields: [carneSaludId], references: [id])
  ordenesAsignadas    EmpleadoAsignado[]
  registrosTrabajo    RegistroDeTrabajo[]
  Usuario             Usuario?
}

model Herramienta {
  id                       Int                @id @default(autoincrement())
  nombre                   String
  tipo                     String?
  marca                    String?
  modelo                   String?
  numeroSerie              String?
  numeroParte              String?
  fechaIngreso             DateTime?
  fechaVencimiento         DateTime?
  certificadoCalibracionId Int?
  archivado                Boolean            @default(false)
  avisos                   Aviso[]            @relation("HerramientaAvisos")
  certificadoCalibracion   Archivo?           @relation("HerramientaCertCalibracion", fields: [certificadoCalibracionId], references: [id])
  ordenesAsignadas         OrdenHerramienta[]
}

model Stock {
  id               Int            @id @default(autoincrement())
  nombre           String
  tipoProducto     String?
  codigoBarras     String?
  notasInternas    String?
  marca            String?
  modelo           String?
  numeroSerie      String?
  puedeSerVendido  Boolean        @default(false)
  puedeSerComprado Boolean        @default(false)
  precioVenta      Float          @default(0)
  coste            Float          @default(0)
  unidadMedida     String?
  cantidad         Int
  stockMinimo      Int
  fechaIngreso     DateTime       @default(now())
  imagenId         Int?
  archivoId        Int?
  archivado        Boolean        @default(false)
  avisos           Aviso[]        @relation("StockAvisos")
  facturas         FacturaStock[] @relation("StockFacturas")
  ordenesUsadas    OrdenStock[]
  archivo          Archivo?       @relation("StockArchivo", fields: [archivoId], references: [id])
  imagen           Archivo?       @relation("StockImagen", fields: [imagenId], references: [id])
}

model FacturaStock {
  id         Int       @id @default(autoincrement())
  stockId    Int
  numero     String?   @db.VarChar(64)
  proveedor  String?   @db.VarChar(128)
  fecha      DateTime?
  monto      Decimal?  @db.Decimal(12, 2)
  moneda     String?   @db.VarChar(8)
  archivo    String?
  archivoId  Int?      @unique
  creadoEn   DateTime  @default(now())
  archivoRef Archivo?  @relation("FacturaStockArchivo", fields: [archivoId], references: [id])
  stock      Stock     @relation("StockFacturas", fields: [stockId], references: [id], onDelete: Cascade)
}

model OrdenTrabajo {
  id                       Int                 @id @default(autoincrement())
  fechaApertura            DateTime            @default(now())
  fechaCierre              DateTime?
  fechaCancelacion         DateTime?
  estadoOrden              EstadoOrden         @default(ABIERTA)
  archivada                Boolean             @default(false)
  avionId                  Int?
  componenteId             Int?
  solicitud                String?
  OTsolicitud              String?
  solicitadoPor            String?
  solicitudFirmaId         Int?
  inspeccionRecibida       Boolean?
  danosPrevios             String?
  accionTomada             String?
  observaciones            String?
  numeroFactura            String?             @unique
  estadoFactura            EstadoFactura       @default(NO_ENVIADA)
  archivoFacturaId         Int?
  datosAvionSnapshot       Json?
  datosComponenteSnapshot  Json?
  datosPropietarioSnapshot Json?
  empleadosAsignados       EmpleadoAsignado[]
  herramientas             OrdenHerramienta[]
  stockAsignado            OrdenStock[]
  archivoFactura           Archivo?            @relation("OTArchivoFactura", fields: [archivoFacturaId], references: [id])
  avion                    Avion?              @relation(fields: [avionId], references: [id])
  componente               ComponenteExterno?  @relation(fields: [componenteId], references: [id])
  solicitudFirma           Archivo?            @relation("OTSolicitudFirma", fields: [solicitudFirmaId], references: [id])
  registrosTrabajo         RegistroDeTrabajo[]
}

model EmpleadoAsignado {
  id         Int                  @id @default(autoincrement())
  ordenId    Int
  empleadoId Int
  rol        RolEmpleadoAsignado?
  empleado   Empleado             @relation(fields: [empleadoId], references: [id])
  orden      OrdenTrabajo         @relation(fields: [ordenId], references: [id])

  @@unique([ordenId, empleadoId, rol])
}

model OrdenStock {
  id                Int          @id @default(autoincrement())
  ordenId           Int
  stockId           Int
  cantidadUtilizada Int
  orden             OrdenTrabajo @relation(fields: [ordenId], references: [id])
  stock             Stock        @relation(fields: [stockId], references: [id])
}

model OrdenHerramienta {
  id            Int          @id @default(autoincrement())
  ordenId       Int
  herramientaId Int
  herramienta   Herramienta  @relation(fields: [herramientaId], references: [id])
  orden         OrdenTrabajo @relation(fields: [ordenId], references: [id])
}

model RegistroDeTrabajo {
  id               Int          @id @default(autoincrement())
  ordenId          Int
  empleadoId       Int
  fecha            DateTime
  horas            Float
  trabajoRealizado String?
  rol              RolEmpleado  @default(TECNICO)
  empleado         Empleado     @relation(fields: [empleadoId], references: [id])
  orden            OrdenTrabajo @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  @@index([ordenId, fecha])
  @@index([empleadoId, fecha])
}

model Aviso {
  id       Int      @id @default(autoincrement())
  mensaje  String
  tipo     String
  leido    Boolean  @default(false)
  creadoEn DateTime @default(now())

  herramientaId Int?
  stockId       Int?
  avionId       Int?

  avion       Avion?       @relation("AvisosDelAvion", fields: [avionId], references: [id])
  herramienta Herramienta? @relation("HerramientaAvisos", fields: [herramientaId], references: [id])
  stock       Stock?       @relation("StockAvisos", fields: [stockId], references: [id])

  @@unique([tipo, avionId], name: "tipo_avionId") // ya la ten√≠as
  @@unique([tipo, stockId], name: "tipo_stockId") // NUEVA
  @@unique([tipo, herramientaId], name: "tipo_herrId") // NUEVA
}

model Usuario {
  id            Int       @id @default(autoincrement())
  keycloakSub   String    @unique
  email         String    @unique
  nombre        String?
  activo        Boolean   @default(true)
  empleadoId    Int?      @unique
  creadoEn      DateTime  @default(now())
  actualizadoEn DateTime  @updatedAt
  empleado      Empleado? @relation(fields: [empleadoId], references: [id])
}

model Archivo {
  id                  Int                 @id @default(autoincrement())
  originalName        String
  mime                String
  sizeOriginal        Int
  sizeAlmacen         Int
  ancho               Int?
  alto                Int?
  hashSha256          String
  storageKey          String
  urlPublica          String?
  createdAt           DateTime            @default(now())
  ordenId             Int?
  avionCertificados   Avion[]             @relation("AvionCertificadoMatricula")
  componentes8130     ComponenteExterno[] @relation("ComponenteArchivo8130")
  empleadosCarneSalud Empleado[]          @relation("EmpleadoCarneSalud")
  facturasStock       FacturaStock?       @relation("FacturaStockArchivo")
  herramientasCert    Herramienta[]       @relation("HerramientaCertCalibracion")
  otsFacturas         OrdenTrabajo[]      @relation("OTArchivoFactura")
  otsSolicitud        OrdenTrabajo[]      @relation("OTSolicitudFirma")
  stockArchivos       Stock[]             @relation("StockArchivo")
  stockImagenes       Stock[]             @relation("StockImagen")
}

enum EstadoFactura {
  NO_ENVIADA
  ENVIADA
  COBRADA
}

enum Estado {
  ACTIVO
  DESINSTALADO
  MANTENIMIENTO
}

enum TipoPropietario {
  PERSONA
  INSTITUCION
}

enum TipoLicencia {
  CELULA.        @map("AERONAVE")
  MOTOR
  AVIONICA
}

enum EstadoOrden {
  ABIERTA
  CERRADA
  CANCELADA
}

enum RolEmpleado {
  TECNICO
  CERTIFICADOR
}

enum RolEmpleadoAsignado {
  TECNICO
  CERTIFICADOR
}

enum EstadoUsuario {
  INVITADO
  ACTIVO
  BLOQUEADO
}
